# This is a basic workflow to help you get started with Actions

name: Deploy Changes To From UAT to Production

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      job-type:
        type: choice
        description: Type of Action
        options:
          - Deployment
          - Validation
        required: true

      target-env:
        type: choice
        description: Select Target
        options:
          - Production
          - Sandbox
        required: true

      source-branch:
        description: Branch to copy metadata
        required: true


# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: sfdx-actions/setup-sfdx@v1
        with:
          sfdx-auth-url: ${{ secrets.SFDX_DEV_PLAYGROUND_AUTH }}

      - name: "Send greeting"
        run: |
          echo "${{ github.event.inputs.job-type }} 
          echo "${{ github.event.inputs.target-env }} 
          echo "${{ github.event.inputs.source-branch }} 

      - name: 'Install Required Updates'
        run: |
          echo "npm version"
          npm --version
          echo "node version"
          node --version
          
          echo "sfdx update"
          sfdx update

          echo "sfdx version"
          sfdx --version

          #echo "Installing sfdx"
          #sudo npm install sfdx-cli --global
          #sfdx --version
          
          #Uninstall SFDX
          #sfdx plugins:uninstall sfdx-git-delta
          
          echo "Installing delta"  
          echo y | sfdx plugins:install sfdx-git-delta

      - name: 'Setting up git env'
        run: |
          git config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'
          git fetch --all
          git checkout -b deploymentBranch
          git --no-pager diff --name-status pr origin/staging